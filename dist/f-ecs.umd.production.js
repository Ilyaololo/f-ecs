!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("tslib"),require("inversify"),require("lodash-es/memoize")):"function"==typeof define&&define.amd?define(["exports","tslib","inversify","lodash-es/memoize"],e):(t=t||self,e(t["f-ecs"]={},t.tslib_1,t.inversify,t._memoize))}(this,function(t,e,n,i){"use strict";function s(t={}){const e={ignore:[]};return Array.isArray(t.ignore)&&(e.ignore=e.ignore.concat(t.ignore)),t=>{const n=Object.getOwnPropertyNames(t.prototype);return n.concat(Object.getOwnPropertySymbols(t.prototype)),n.filter(t=>!e.ignore.includes(t)).forEach(e=>{if("constructor"===e)return;const n=Object.getOwnPropertyDescriptor(t.prototype,e);"function"==typeof n.value&&n.configurable&&Object.defineProperty(t.prototype,e,{enumerable:n.enumerable,configurable:n.configurable,get(){if(Object.prototype.hasOwnProperty.call(this,e))return n.value;const t=n.value.bind(this);return Object.defineProperty(this,e,{enumerable:n.enumerable,configurable:n.configurable,value:t,writable:!1!==n.writable}),t},set(i){!1!==n.writable&&Object.defineProperty(t.prototype,e,{value:i,configurable:!0,enumerable:!0,writable:!0})}})}),t}}function o(t){return(e,n,i)=>{if(i)return i.configurable=t.configurable,i.enumerable=t.enumerable,i.writable=t.writable,i;Object.defineProperty(e,n,{configurable:t.configurable,enumerable:t.enumerable,writable:t.writable})}}i=i&&i.hasOwnProperty("default")?i.default:i,t.Components=class{toString(){return this.displayName}},t.Components=e.__decorate([s()],t.Components),t.EventEmitter=class{constructor(){this.listener=new Map}emit(t,...e){if(!this.listener.has(t))return;const n=this.listener.get(t);n&&n.forEach(t=>{t(...e)})}off(t,e){if(!this.listener.has(t))return this;const n=this.listener.get(t);return n?(this.listener.set(t,n.filter(t=>t!==e)),this):this}on(t,e){if("function"!=typeof e)throw new Error("Listener must be a function");const n=this.listener.get(t);return this.listener.set(t,n?[...n,e]:[e]),this}once(t,e){if("function"!=typeof e)throw new Error("Listener must be a function");const n=this.listener.get(t),i=(...n)=>{e(...n),this.off(t,i)};return this.listener.set(t,n?[...n,i]:[i]),this}},e.__decorate([o({enumerable:!1}),e.__metadata("design:type",Function),e.__metadata("design:paramtypes",[String,Object]),e.__metadata("design:returntype",void 0)],t.EventEmitter.prototype,"emit",null),e.__decorate([o({enumerable:!1}),e.__metadata("design:type",Function),e.__metadata("design:paramtypes",[String,Function]),e.__metadata("design:returntype",Object)],t.EventEmitter.prototype,"off",null),e.__decorate([o({enumerable:!1}),e.__metadata("design:type",Function),e.__metadata("design:paramtypes",[String,Function]),e.__metadata("design:returntype",Object)],t.EventEmitter.prototype,"on",null),e.__decorate([o({enumerable:!1}),e.__metadata("design:type",Function),e.__metadata("design:paramtypes",[String,Function]),e.__metadata("design:returntype",Object)],t.EventEmitter.prototype,"once",null),t.EventEmitter=e.__decorate([s(),n.injectable()],t.EventEmitter);t.Entity=class extends t.EventEmitter{constructor(t){super(),this.name=t,this.next=null,this.previous=null,this.components=new Map}get displayName(){return this.name}set displayName(t){if(this.name!==t){const e=this.name;this.name=t,this.emit("@@entity/ENTITY_CHANGE_DISPLAY_NAME_EVENT",e)}}toString(){return this.name}set(t){if(!t.displayName){const e=Object.getPrototypeOf(t);throw new Error(`Invalid property 'displayName' of class '${e.constructor.name}'`)}return this.components.has(t.displayName)&&this.delete(t),this.components.set(t.displayName,t),this.emit("@@entity/ENTITY_SET_COMPONENT_EVENT",this,t),this}get(t){return this.components.has(t)?this.components.get(t):null}has(t){return this.components.has(t)}delete(t){return this.components.has(t.displayName)?(this.components.delete(t.displayName),this.emit("@@entity/ENTITY_DELETE_COMPONENT_EVENT",this,t),t):null}},t.Entity=e.__decorate([s(),e.__metadata("design:paramtypes",[String])],t.Entity),t.EntityList=class{constructor(){this.head=null,this.tail=null}[Symbol.iterator](){const t={};return t.__value=this.head,t.next=(()=>{if(!t.__value)return{done:!0,value:null};const e=t.__value;return t.__value=e.next,{done:!e,value:e}}),t}has(t){for(const e of this)if(e===t)return!0;return!1}set(t){this.head&&this.tail?(this.tail.next=t,t.previous=this.tail,t.next=null,this.tail=t):(this.head=t,this.tail=t,t.next=null,t.previous=null)}delete(t){this.head===t&&(this.head=this.head.next),this.tail===t&&(this.tail=this.tail.previous),t.previous&&(t.previous.next=t.next),t.next&&(t.next.previous=t.previous)}forEach(t){for(const e of this)t(e)}clear(){for(const t of this)t.next=null,t.previous=null;this.tail=null}},t.EntityList=e.__decorate([s()],t.EntityList);t.Node=class{constructor(){this.entity=null,this.next=null,this.previous=null}},t.Node=e.__decorate([s()],t.Node),t.NodeList=class extends t.EventEmitter{constructor(){super(...arguments),this.head=null,this.tail=null}[Symbol.iterator](){const t={};return t.__value=this.head,t.next=(()=>{if(!t.__value)return{done:!0,value:null};const e=t.__value;return t.__value=e.next,{done:!e,value:e}}),t}delete(t){this.head===t&&(this.head=this.head.next),this.tail===t&&(this.tail=this.tail.previous),t.previous&&(t.previous.next=t.next),t.next&&(t.next.previous=t.previous),this.emit("@@nodeList/NODE_LIST_DELETE_NODE_EVENT",t)}set(t){this.head&&this.tail?(this.tail.next=t,t.previous=this.tail,t.next=null,this.tail=t):(this.head=t,this.tail=t,t.next=null,t.previous=null),this.emit("@@nodeList/NODE_LIST_SET_NODE_EVENT",t)}forEach(t){for(const e of this)t(e)}clear(){for(const t of this)t.previous=null,t.next=null,this.emit("@@nodeList/NODE_LIST_DELETE_NODE_EVENT",t)}},t.NodeList=e.__decorate([s()],t.NodeList);const r="@@components";t.NodePool=class{constructor(t,e){this.node=t,this.components=e,this.tail=null}get(){if(this.tail){const t=this.tail;return this.tail=this.tail.previous,t.previous=null,t}const t=this.node;return new t}dispose(t){for(const e of this.components){const n=e[1];t[String(n)]=null}t.entity=null,t.next=null,t.previous=null,this.tail=t}},t.NodePool=e.__decorate([s(),e.__metadata("design:paramtypes",[Object,Map])],t.NodePool),t.NodeManager=class{constructor(e){this.node=e,this.components=new Map,this.entities=new Map,this.nodes=new t.NodeList,this.pool=new t.NodePool(e,this.components);const n=Reflect.getMetadata(r,e.prototype);n&&n.forEach(t=>{const e=new t;this.components.set(String(e),e)})}get nodeList(){return this.nodes}delete(t){if(!this.entities.has(String(t)))return;const e=this.entities.get(String(t));this.entities.delete(String(t)),this.nodes.delete(e),this.pool.dispose(e)}set(t){if(this.entities.has(String(t)))return;for(const e of this.components){const n=e[0];if(!t.has(n))return}const e=this.pool.get();e.entity=t;for(const n of this.components){const i=n[0],s=n[0];e[String(s)]=t.get(i)}this.entities.set(String(t),e),this.nodes.set(e)}clear(){this.nodes.forEach(t=>{this.entities.delete(String(t.entity))})}},t.NodeManager=e.__decorate([s(),e.__metadata("design:paramtypes",[Object])],t.NodeManager),t.System=class{constructor(){this.next=null,this.previous=null}start(t){}destroy(t){}update(t){}},t.System=e.__decorate([s(),n.injectable()],t.System),t.SystemList=class{constructor(){this.head=null,this.tail=null}[Symbol.iterator](){const t={};return t.__value=this.head,t.next=(()=>{if(!t.__value)return{done:!0,value:null};const e=t.__value;return t.__value=e.next,{done:!e,value:e}}),t}delete(t){this.head===t&&(this.head=this.head.next),this.tail===t&&(this.tail=this.tail.previous),t.previous&&(t.previous.next=t.next),t.next&&(t.next.previous=t.previous)}set(t){this.head&&this.tail?(this.tail.next=t,t.previous=this.tail,t.next=null,this.tail=t):(this.head=t,this.tail=t,t.next=null,t.previous=null)}forEach(t){for(const e of this)t(e)}clear(){for(const t of this)t.previous=null,t.next=null}},t.SystemList=e.__decorate([s()],t.SystemList),t.Core=class extends t.EventEmitter{constructor(){super(),this.entities=new t.EntityList,this.nodes=new Map,this.systems=new t.SystemList}onEntityDeleteComponent(t){this.nodes.forEach(e=>{e.delete(t)})}onEntitySetComponent(t){this.nodes.forEach(e=>{e.set(t)})}appendEntity(t){if(this.entities.has(t))throw new Error(`Entity '${t.displayName}' is already used by another entity`);return this.entities.set(t),t.on("@@entity/ENTITY_DELETE_COMPONENT_EVENT",this.onEntityDeleteComponent),t.on("@@entity/ENTITY_SET_COMPONENT_EVENT",this.onEntitySetComponent),this.nodes.forEach(e=>{e.set(t)}),this}removeEntity(t){return t.off("@@entity/ENTITY_DELETE_COMPONENT_EVENT",this.onEntityDeleteComponent),t.off("@@entity/ENTITY_SET_COMPONENT_EVENT",this.onEntitySetComponent),this.nodes.forEach(e=>{e.delete(t)}),this.entities.delete(t),this}appendSystem(t){const e="function"==typeof t?t():t;return this.systems.set(e),e.start(this),this}removeSystem(t){return t.destroy(this),this.systems.delete(t),this}getNodeList(e){if(this.nodes.has(e))return this.nodes.get(e).nodeList;const n=new t.NodeManager(e);return this.nodes.set(e,n),this.entities.forEach(t=>{n.set(t)}),n.nodeList}update(t){this.systems.forEach(e=>{e.update(t)})}},t.Core=e.__decorate([s(),n.injectable(),e.__metadata("design:paramtypes",[])],t.Core),t.Bind=s,t.Define=function(t){return e=>{let n=[];Reflect.hasMetadata(r,e)?n=Reflect.getMetadata(r,e):Reflect.defineMetadata(r,n,e),n.push(t)}},t.Descriptor=o,t.ENTITY_CHANGE_DISPLAY_NAME_EVENT="@@entity/ENTITY_CHANGE_DISPLAY_NAME_EVENT",t.ENTITY_DELETE_COMPONENT_EVENT="@@entity/ENTITY_DELETE_COMPONENT_EVENT",t.ENTITY_SET_COMPONENT_EVENT="@@entity/ENTITY_SET_COMPONENT_EVENT",t.Memoize=function(){return(t,e)=>(i.Cache=WeakMap,i(t[e]))},t.NODE_LIST_DELETE_NODE_EVENT="@@nodeList/NODE_LIST_DELETE_NODE_EVENT",t.NODE_LIST_SET_NODE_EVENT="@@nodeList/NODE_LIST_SET_NODE_EVENT",t.StateMachine=class{},t.__COMPONENTS__=r,t.deg=function(t){return t*Math.PI/180}});
//# sourceMappingURL=f-ecs.umd.production.js.map
