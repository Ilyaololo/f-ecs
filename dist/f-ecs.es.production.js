import{__decorate as t,__metadata as e}from"tslib";import{injectable as n}from"inversify";import s from"lodash-es/memoize";function i(t={}){const e={ignore:[]};return Array.isArray(t.ignore)&&(e.ignore=e.ignore.concat(t.ignore)),t=>{const n=Object.getOwnPropertyNames(t.prototype);return n.concat(Object.getOwnPropertySymbols(t.prototype)),n.filter(t=>!e.ignore.includes(t)).forEach(e=>{if("constructor"===e)return;const n=Object.getOwnPropertyDescriptor(t.prototype,e);"function"==typeof n.value&&n.configurable&&Object.defineProperty(t.prototype,e,{enumerable:n.enumerable,configurable:n.configurable,get(){if(Object.prototype.hasOwnProperty.call(this,e))return n.value;const t=n.value.bind(this);return Object.defineProperty(this,e,{enumerable:n.enumerable,configurable:n.configurable,value:t,writable:!1!==n.writable}),t},set(s){!1!==n.writable&&Object.defineProperty(t.prototype,e,{value:s,configurable:!0,enumerable:!0,writable:!0})}})}),t}}let o=class{toString(){return this.displayName}};function r(t){return(e,n,s)=>{if(s)return s.configurable=t.configurable,s.enumerable=t.enumerable,s.writable=t.writable,s;Object.defineProperty(e,n,{configurable:t.configurable,enumerable:t.enumerable,writable:t.writable})}}o=t([i()],o);let l=class{constructor(){this.listener=new Map}emit(t,...e){if(!this.listener.has(t))return;const n=this.listener.get(t);n&&n.forEach(t=>{t(...e)})}off(t,e){if(!this.listener.has(t))return this;const n=this.listener.get(t);return n?(this.listener.set(t,n.filter(t=>t!==e)),this):this}on(t,e){if("function"!=typeof e)throw new Error("Listener must be a function");const n=this.listener.get(t);return this.listener.set(t,n?[...n,e]:[e]),this}once(t,e){if("function"!=typeof e)throw new Error("Listener must be a function");const n=this.listener.get(t),s=(...n)=>{e(...n),this.off(t,s)};return this.listener.set(t,n?[...n,s]:[s]),this}};t([r({enumerable:!1}),e("design:type",Function),e("design:paramtypes",[String,Object]),e("design:returntype",void 0)],l.prototype,"emit",null),t([r({enumerable:!1}),e("design:type",Function),e("design:paramtypes",[String,Function]),e("design:returntype",Object)],l.prototype,"off",null),t([r({enumerable:!1}),e("design:type",Function),e("design:paramtypes",[String,Function]),e("design:returntype",Object)],l.prototype,"on",null),t([r({enumerable:!1}),e("design:type",Function),e("design:paramtypes",[String,Function]),e("design:returntype",Object)],l.prototype,"once",null),l=t([i(),n()],l);const a="@@entity/ENTITY_CHANGE_DISPLAY_NAME_EVENT",h="@@entity/ENTITY_DELETE_COMPONENT_EVENT",u="@@entity/ENTITY_SET_COMPONENT_EVENT",c="@@nodeList/NODE_LIST_DELETE_NODE_EVENT",p="@@nodeList/NODE_LIST_SET_NODE_EVENT";let d=class extends l{constructor(t){super(),this.name=t,this.next=null,this.previous=null,this.components=new Map}get displayName(){return this.name}set displayName(t){if(this.name!==t){const e=this.name;this.name=t,this.emit("@@entity/ENTITY_CHANGE_DISPLAY_NAME_EVENT",e)}}toString(){return this.name}set(t){if(!t.displayName){const e=Object.getPrototypeOf(t);throw new Error(`Invalid property 'displayName' of class '${e.constructor.name}'`)}return this.components.has(t.displayName)&&this.delete(t),this.components.set(t.displayName,t),this.emit("@@entity/ENTITY_SET_COMPONENT_EVENT",this,t),this}get(t){return this.components.has(t)?this.components.get(t):null}has(t){return this.components.has(t)}delete(t){return this.components.has(t.displayName)?(this.components.delete(t.displayName),this.emit("@@entity/ENTITY_DELETE_COMPONENT_EVENT",this,t),t):null}};d=t([i(),e("design:paramtypes",[String])],d);let E=class{constructor(){this.head=null,this.tail=null}[Symbol.iterator](){const t={};return t.__value=this.head,t.next=(()=>{if(!t.__value)return{done:!0,value:null};const e=t.__value;return t.__value=e.next,{done:!e,value:e}}),t}has(t){for(const e of this)if(e===t)return!0;return!1}set(t){this.head&&this.tail?(this.tail.next=t,t.previous=this.tail,t.next=null,this.tail=t):(this.head=t,this.tail=t,t.next=null,t.previous=null)}delete(t){this.head===t&&(this.head=this.head.next),this.tail===t&&(this.tail=this.tail.previous),t.previous&&(t.previous.next=t.next),t.next&&(t.next.previous=t.previous)}forEach(t){for(const e of this)t(e)}clear(){for(const t of this)t.next=null,t.previous=null;this.tail=null}};E=t([i()],E);class f{}let y=class{constructor(){this.entity=null,this.next=null,this.previous=null}};y=t([i()],y);let m=class extends l{constructor(){super(...arguments),this.head=null,this.tail=null}[Symbol.iterator](){const t={};return t.__value=this.head,t.next=(()=>{if(!t.__value)return{done:!0,value:null};const e=t.__value;return t.__value=e.next,{done:!e,value:e}}),t}delete(t){this.head===t&&(this.head=this.head.next),this.tail===t&&(this.tail=this.tail.previous),t.previous&&(t.previous.next=t.next),t.next&&(t.next.previous=t.previous),this.emit("@@nodeList/NODE_LIST_DELETE_NODE_EVENT",t)}set(t){this.head&&this.tail?(this.tail.next=t,t.previous=this.tail,t.next=null,this.tail=t):(this.head=t,this.tail=t,t.next=null,t.previous=null),this.emit("@@nodeList/NODE_LIST_SET_NODE_EVENT",t)}forEach(t){for(const e of this)t(e)}clear(){for(const t of this)t.previous=null,t.next=null,this.emit("@@nodeList/NODE_LIST_DELETE_NODE_EVENT",t)}};m=t([i()],m);const _="@@components";function g(t){return e=>{let n=[];Reflect.hasMetadata(_,e)?n=Reflect.getMetadata(_,e):Reflect.defineMetadata(_,n,e),n.push(t)}}let N=class{constructor(t,e){this.node=t,this.components=e,this.tail=null}get(){if(this.tail){const t=this.tail;return this.tail=this.tail.previous,t.previous=null,t}const t=this.node;return new t}dispose(t){for(const e of this.components){const n=e[1];t[String(n)]=null}t.entity=null,t.next=null,t.previous=null,this.tail=t}};N=t([i(),e("design:paramtypes",[Object,Map])],N);let T=class{constructor(t){this.node=t,this.components=new Map,this.entities=new Map,this.nodes=new m,this.pool=new N(t,this.components);const e=Reflect.getMetadata(_,t.prototype);e&&e.forEach(t=>{const e=new t;this.components.set(String(e),e)})}get nodeList(){return this.nodes}delete(t){if(!this.entities.has(String(t)))return;const e=this.entities.get(String(t));this.entities.delete(String(t)),this.nodes.delete(e),this.pool.dispose(e)}set(t){if(this.entities.has(String(t)))return;for(const e of this.components){const n=e[0];if(!t.has(n))return}const e=this.pool.get();e.entity=t;for(const n of this.components){const s=n[0],i=n[0];e[String(i)]=t.get(s)}this.entities.set(String(t),e),this.nodes.set(e)}clear(){this.nodes.forEach(t=>{this.entities.delete(String(t.entity))})}};T=t([i(),e("design:paramtypes",[Object])],T);let v=class{constructor(){this.next=null,this.previous=null}start(t){}destroy(t){}update(t){}};v=t([i(),n()],v);let b=class{constructor(){this.head=null,this.tail=null}[Symbol.iterator](){const t={};return t.__value=this.head,t.next=(()=>{if(!t.__value)return{done:!0,value:null};const e=t.__value;return t.__value=e.next,{done:!e,value:e}}),t}delete(t){this.head===t&&(this.head=this.head.next),this.tail===t&&(this.tail=this.tail.previous),t.previous&&(t.previous.next=t.next),t.next&&(t.next.previous=t.previous)}set(t){this.head&&this.tail?(this.tail.next=t,t.previous=this.tail,t.next=null,this.tail=t):(this.head=t,this.tail=t,t.next=null,t.previous=null)}forEach(t){for(const e of this)t(e)}clear(){for(const t of this)t.previous=null,t.next=null}};function O(t){return t*Math.PI/180}function x(){return(t,e)=>(s.Cache=WeakMap,s(t[e]))}b=t([i()],b);let S=class extends l{constructor(){super(),this.entities=new E,this.nodes=new Map,this.systems=new b}onEntityDeleteComponent(t){this.nodes.forEach(e=>{e.delete(t)})}onEntitySetComponent(t){this.nodes.forEach(e=>{e.set(t)})}appendEntity(t){if(this.entities.has(t))throw new Error(`Entity '${t.displayName}' is already used by another entity`);return this.entities.set(t),t.on("@@entity/ENTITY_DELETE_COMPONENT_EVENT",this.onEntityDeleteComponent),t.on("@@entity/ENTITY_SET_COMPONENT_EVENT",this.onEntitySetComponent),this.nodes.forEach(e=>{e.set(t)}),this}removeEntity(t){return t.off("@@entity/ENTITY_DELETE_COMPONENT_EVENT",this.onEntityDeleteComponent),t.off("@@entity/ENTITY_SET_COMPONENT_EVENT",this.onEntitySetComponent),this.nodes.forEach(e=>{e.delete(t)}),this.entities.delete(t),this}appendSystem(t){const e="function"==typeof t?t():t;return this.systems.set(e),e.start(this),this}removeSystem(t){return t.destroy(this),this.systems.delete(t),this}getNodeList(t){if(this.nodes.has(t))return this.nodes.get(t).nodeList;const e=new T(t);return this.nodes.set(t,e),this.entities.forEach(t=>{e.set(t)}),e.nodeList}update(t){this.systems.forEach(e=>{e.update(t)})}};S=t([i(),n(),e("design:paramtypes",[])],S);export{i as Bind,o as Components,S as Core,g as Define,r as Descriptor,a as ENTITY_CHANGE_DISPLAY_NAME_EVENT,h as ENTITY_DELETE_COMPONENT_EVENT,u as ENTITY_SET_COMPONENT_EVENT,d as Entity,E as EntityList,l as EventEmitter,x as Memoize,c as NODE_LIST_DELETE_NODE_EVENT,p as NODE_LIST_SET_NODE_EVENT,y as Node,m as NodeList,T as NodeManager,N as NodePool,f as StateMachine,v as System,b as SystemList,_ as __COMPONENTS__,O as deg};
//# sourceMappingURL=f-ecs.es.production.js.map
