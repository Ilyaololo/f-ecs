"use strict";var t,e=require("tslib"),s=require("inversify"),n=(t=require("lodash/memoize"),t&&"object"==typeof t&&"default"in t?t.default:t);function i(t={}){const e={ignore:[]};return Array.isArray(t.ignore)&&(e.ignore=e.ignore.concat(t.ignore)),t=>{const s=Object.getOwnPropertyNames(t.prototype);return s.concat(Object.getOwnPropertySymbols(t.prototype)),s.filter(t=>!e.ignore.includes(t)).forEach(e=>{if("constructor"===e)return;const s=Object.getOwnPropertyDescriptor(t.prototype,e);"function"==typeof s.value&&s.configurable&&Object.defineProperty(t.prototype,e,{enumerable:s.enumerable,configurable:s.configurable,get(){if(Object.prototype.hasOwnProperty.call(this,e))return s.value;const t=s.value.bind(this);return Object.defineProperty(this,e,{enumerable:s.enumerable,configurable:s.configurable,value:t,writable:!1!==s.writable}),t},set(n){!1!==s.writable&&Object.defineProperty(t.prototype,e,{value:n,configurable:!0,enumerable:!0,writable:!0})}})}),t}}function o(t){return(e,s,n)=>{if(n)return n.configurable=t.configurable,n.enumerable=t.enumerable,n.writable=t.writable,n;Object.defineProperty(e,s,{configurable:t.configurable,enumerable:t.enumerable,writable:t.writable})}}exports.Components=class{toString(){return this.displayName}},exports.Components=e.__decorate([i()],exports.Components),exports.EventEmitter=class{constructor(){this.listener=new Map}emit(t,...e){if(!this.listener.has(t))return;const s=this.listener.get(t);s&&s.forEach(t=>{t(...e)})}off(t,e){if(!this.listener.has(t))return this;const s=this.listener.get(t);return s?(this.listener.set(t,s.filter(t=>t!==e)),this):this}on(t,e){if("function"!=typeof e)throw new Error("Listener must be a function");const s=this.listener.get(t);return this.listener.set(t,s?[...s,e]:[e]),this}once(t,e){if("function"!=typeof e)throw new Error("Listener must be a function");const s=this.listener.get(t),n=(...s)=>{e(...s),this.off(t,n)};return this.listener.set(t,s?[...s,n]:[n]),this}},e.__decorate([o({enumerable:!1}),e.__metadata("design:type",Function),e.__metadata("design:paramtypes",[String,Object]),e.__metadata("design:returntype",void 0)],exports.EventEmitter.prototype,"emit",null),e.__decorate([o({enumerable:!1}),e.__metadata("design:type",Function),e.__metadata("design:paramtypes",[String,Function]),e.__metadata("design:returntype",Object)],exports.EventEmitter.prototype,"off",null),e.__decorate([o({enumerable:!1}),e.__metadata("design:type",Function),e.__metadata("design:paramtypes",[String,Function]),e.__metadata("design:returntype",Object)],exports.EventEmitter.prototype,"on",null),e.__decorate([o({enumerable:!1}),e.__metadata("design:type",Function),e.__metadata("design:paramtypes",[String,Function]),e.__metadata("design:returntype",Object)],exports.EventEmitter.prototype,"once",null),exports.EventEmitter=e.__decorate([i(),s.injectable()],exports.EventEmitter);exports.Entity=class extends exports.EventEmitter{constructor(t){super(),this.name=t,this.next=null,this.previous=null,this.components=new Map}get displayName(){return this.name}set displayName(t){if(this.name!==t){const e=this.name;this.name=t,this.emit("@@entity/ENTITY_CHANGE_DISPLAY_NAME_EVENT",e)}}toString(){return this.name}set(t){if(!t.displayName){const e=Object.getPrototypeOf(t);throw new Error(`Invalid property 'displayName' of class '${e.constructor.name}'`)}return this.components.has(t.displayName)&&this.delete(t),this.components.set(t.displayName,t),this.emit("@@entity/ENTITY_SET_COMPONENT_EVENT",this,t),this}get(t){return this.components.has(t)?this.components.get(t):null}has(t){return this.components.has(t)}delete(t){return this.components.has(t.displayName)?(this.components.delete(t.displayName),this.emit("@@entity/ENTITY_DELETE_COMPONENT_EVENT",this,t),t):null}},exports.Entity=e.__decorate([i(),e.__metadata("design:paramtypes",[String])],exports.Entity),exports.EntityList=class{constructor(){this.head=null,this.tail=null}[Symbol.iterator](){const t={};return t.__value=this.head,t.next=(()=>{if(!t.__value)return{done:!0,value:null};const e=t.__value;return t.__value=e.next,{done:!e,value:e}}),t}has(t){for(const e of this)if(e===t)return!0;return!1}set(t){this.head&&this.tail?(this.tail.next=t,t.previous=this.tail,t.next=null,this.tail=t):(this.head=t,this.tail=t,t.next=null,t.previous=null)}delete(t){this.head===t&&(this.head=this.head.next),this.tail===t&&(this.tail=this.tail.previous),t.previous&&(t.previous.next=t.next),t.next&&(t.next.previous=t.previous)}forEach(t){for(const e of this)t(e)}clear(){for(const t of this)t.next=null,t.previous=null;this.tail=null}},exports.EntityList=e.__decorate([i()],exports.EntityList);exports.Node=class{constructor(){this.entity=null,this.next=null,this.previous=null}},exports.Node=e.__decorate([i()],exports.Node),exports.NodeList=class extends exports.EventEmitter{constructor(){super(...arguments),this.head=null,this.tail=null}[Symbol.iterator](){const t={};return t.__value=this.head,t.next=(()=>{if(!t.__value)return{done:!0,value:null};const e=t.__value;return t.__value=e.next,{done:!e,value:e}}),t}delete(t){this.head===t&&(this.head=this.head.next),this.tail===t&&(this.tail=this.tail.previous),t.previous&&(t.previous.next=t.next),t.next&&(t.next.previous=t.previous),this.emit("@@nodeList/NODE_LIST_DELETE_NODE_EVENT",t)}set(t){this.head&&this.tail?(this.tail.next=t,t.previous=this.tail,t.next=null,this.tail=t):(this.head=t,this.tail=t,t.next=null,t.previous=null),this.emit("@@nodeList/NODE_LIST_SET_NODE_EVENT",t)}forEach(t){for(const e of this)t(e)}clear(){for(const t of this)t.previous=null,t.next=null,this.emit("@@nodeList/NODE_LIST_DELETE_NODE_EVENT",t)}},exports.NodeList=e.__decorate([i()],exports.NodeList);const r="@@components";exports.NodePool=class{constructor(t,e){this.node=t,this.components=e,this.tail=null}get(){if(this.tail){const t=this.tail;return this.tail=this.tail.previous,t.previous=null,t}const t=this.node;return new t}dispose(t){for(const e of this.components){const s=e[1];t[String(s)]=null}t.entity=null,t.next=null,t.previous=null,this.tail=t}},exports.NodePool=e.__decorate([i(),e.__metadata("design:paramtypes",[Object,Map])],exports.NodePool),exports.NodeManager=class{constructor(t){this.node=t,this.components=new Map,this.entities=new Map,this.nodes=new exports.NodeList,this.pool=new exports.NodePool(t,this.components);const e=Reflect.getMetadata(r,t.prototype);e&&e.forEach(t=>{const e=new t;this.components.set(String(e),e)})}get nodeList(){return this.nodes}delete(t){if(!this.entities.has(String(t)))return;const e=this.entities.get(String(t));this.entities.delete(String(t)),this.nodes.delete(e),this.pool.dispose(e)}set(t){if(this.entities.has(String(t)))return;for(const e of this.components){const s=e[0];if(!t.has(s))return}const e=this.pool.get();e.entity=t;for(const s of this.components){const n=s[0],i=s[0];e[String(i)]=t.get(n)}this.entities.set(String(t),e),this.nodes.set(e)}clear(){this.nodes.forEach(t=>{this.entities.delete(String(t.entity))})}},exports.NodeManager=e.__decorate([i(),e.__metadata("design:paramtypes",[Object])],exports.NodeManager),exports.System=class{constructor(){this.next=null,this.previous=null}start(t){}destroy(t){}update(t){}},exports.System=e.__decorate([i(),s.injectable()],exports.System),exports.SystemList=class{constructor(){this.head=null,this.tail=null}[Symbol.iterator](){const t={};return t.__value=this.head,t.next=(()=>{if(!t.__value)return{done:!0,value:null};const e=t.__value;return t.__value=e.next,{done:!e,value:e}}),t}delete(t){this.head===t&&(this.head=this.head.next),this.tail===t&&(this.tail=this.tail.previous),t.previous&&(t.previous.next=t.next),t.next&&(t.next.previous=t.previous)}set(t){this.head&&this.tail?(this.tail.next=t,t.previous=this.tail,t.next=null,this.tail=t):(this.head=t,this.tail=t,t.next=null,t.previous=null)}forEach(t){for(const e of this)t(e)}clear(){for(const t of this)t.previous=null,t.next=null}},exports.SystemList=e.__decorate([i()],exports.SystemList),exports.Core=class extends exports.EventEmitter{constructor(){super(),this.entities=new exports.EntityList,this.nodes=new Map,this.systems=new exports.SystemList}onEntityDeleteComponent(t){this.nodes.forEach(e=>{e.delete(t)})}onEntitySetComponent(t){this.nodes.forEach(e=>{e.set(t)})}appendEntity(t){if(this.entities.has(t))throw new Error(`Entity '${t.displayName}' is already used by another entity`);return this.entities.set(t),t.on("@@entity/ENTITY_DELETE_COMPONENT_EVENT",this.onEntityDeleteComponent),t.on("@@entity/ENTITY_SET_COMPONENT_EVENT",this.onEntitySetComponent),this.nodes.forEach(e=>{e.set(t)}),this}removeEntity(t){return t.off("@@entity/ENTITY_DELETE_COMPONENT_EVENT",this.onEntityDeleteComponent),t.off("@@entity/ENTITY_SET_COMPONENT_EVENT",this.onEntitySetComponent),this.nodes.forEach(e=>{e.delete(t)}),this.entities.delete(t),this}appendSystem(t){const e="function"==typeof t?t():t;return this.systems.set(e),e.start(this),this}removeSystem(t){return t.destroy(this),this.systems.delete(t),this}getNodeList(t){if(this.nodes.has(t))return this.nodes.get(t).nodeList;const e=new exports.NodeManager(t);return this.nodes.set(t,e),this.entities.forEach(t=>{e.set(t)}),e.nodeList}update(t){this.systems.forEach(e=>{e.update(t)})}},exports.Core=e.__decorate([i(),s.injectable(),e.__metadata("design:paramtypes",[])],exports.Core),exports.Bind=i,exports.Define=function(t){return e=>{let s=[];Reflect.hasMetadata(r,e)?s=Reflect.getMetadata(r,e):Reflect.defineMetadata(r,s,e),s.push(t)}},exports.Descriptor=o,exports.ENTITY_CHANGE_DISPLAY_NAME_EVENT="@@entity/ENTITY_CHANGE_DISPLAY_NAME_EVENT",exports.ENTITY_DELETE_COMPONENT_EVENT="@@entity/ENTITY_DELETE_COMPONENT_EVENT",exports.ENTITY_SET_COMPONENT_EVENT="@@entity/ENTITY_SET_COMPONENT_EVENT",exports.Memoize=function(){return(t,e)=>(n.Cache=WeakMap,n(t[e]))},exports.NODE_LIST_DELETE_NODE_EVENT="@@nodeList/NODE_LIST_DELETE_NODE_EVENT",exports.NODE_LIST_SET_NODE_EVENT="@@nodeList/NODE_LIST_SET_NODE_EVENT",exports.StateMachine=class{},exports.__COMPONENTS__=r,exports.deg=function(t){return t*Math.PI/180};
//# sourceMappingURL=f-ecs.cjs.production.js.map
